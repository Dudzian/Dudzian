name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:

env:
  PYSIDE6_VERSION: "6.6.1"

jobs:
  prepare-pyside6-wheel:
    name: Prepare PySide6 wheels (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare wheelhouse directory
        run: mkdir -p wheelhouse

      - name: Cache PySide6 wheels
        id: wheel-cache
        uses: actions/cache@v4
        with:
          path: wheelhouse
          key: pyside6-${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-${{ env.PYSIDE6_VERSION }}

      - name: Download PySide6 distribution
        if: steps.wheel-cache.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip download PySide6==${{ env.PYSIDE6_VERSION }} --dest wheelhouse --only-binary=:all:

      - name: Upload PySide6 wheels
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-wheels-linux-${{ env.PYSIDE6_VERSION }}
          path: wheelhouse
          if-no-files-found: error

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Lint repository paths
        env:
          LINT_PATHS_ALLOW_LEGACY: "1"
        run: python scripts/lint_paths.py

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r KryptoLowca/requirements.txt
          pip install pytest pytest-cov pre-commit

      - name: Pre-commit (ruff + mypy)
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Pytest with coverage
        run: >-
          pytest
          --cov=bot_core.strategies
          --cov=bot_core.runtime.multi_strategy_scheduler
          --cov=bot_core.runtime.journal
          --cov-config=.coveragerc
          --cov-report=xml
          --cov-report=term
          --cov-fail-under=75
          tests/test_pipeline_paper.py
          tests/test_risk_profiles.py
          tests/test_mean_reversion_strategy.py
          tests/test_volatility_target_strategy.py
          tests/test_cross_exchange_arbitrage_strategy.py
          tests/test_multi_strategy_scheduler.py
          tests/test_backtest_dataset_library.py
          tests/test_telemetry_risk_profiles.py
          tests/test_trading_decision_journal.py
          tests/test_smoke_demo_strategies_cli.py
          KryptoLowca/tests/strategies/test_registry.py

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  release-quality-gates:
    name: Release Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Lint repository paths
        run: python scripts/lint_paths.py

      - name: Type check with mypy
        run: mypy

      - name: Pytest demoâ†’paper scenario
        run: pytest -m e2e_demo_paper --maxfail=1 --disable-warnings

      - name: Pytest paper execution smoke
        run: pytest tests/test_paper_execution.py

      - name: Pytest execution router integrations
        run: pytest tests/integration/test_execution_router_failover.py

  bot-core-fast-tests:
    name: Bot Core Fast Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Generate trading stubs
        run: python scripts/generate_trading_stubs.py --skip-cpp

      - name: Run fast pytest suite
        env:
          PYTEST_FAST: "1"
        run: |
          mkdir -p test-results
          pytest --fast --maxfail=1 --durations=10 --junitxml=test-results/pytest.xml

      - name: Upload pytest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-core-pytest-results
          path: test-results/pytest.xml

      - name: Generate champion diff audit report
        if: always()
        run: >-
          python -m scripts.audit.champion_diff
          --lhs deploy/packaging/samples/var/models/quality
          --rhs var/models/quality
          --output-dir audit/champion_diffs_ci
          --tag ci

      - name: Upload champion diff audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: champion-quality-diff
          path: audit/champion_diffs_ci
          if-no-files-found: warn

  loopback-e2e:
    name: Loopback E2E
    runs-on: ubuntu-latest
    needs: bot-core-fast-tests

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run loopback tests via Docker Compose
        run: docker compose -f deploy/compose/loopback-tests.yml up --abort-on-container-exit

      - name: Tear down compose
        if: always()
        run: docker compose -f deploy/compose/loopback-tests.yml down -v

  coverage-monitoring:
    name: Coverage Monitoring Smoke
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r KryptoLowca/requirements.txt
          pip install .
          pip install grpcio-tools

      - name: Generate trading stubs
        run: python scripts/generate_trading_stubs.py --skip-cpp

  ui-ctest:
    name: UI Native Tests
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build pkg-config \
            libprotobuf-dev protobuf-compiler protobuf-compiler-grpc \
            libgrpc-dev libgrpc++-dev libarchive-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 6.5.3
          modules: qtcharts qtquickcontrols2 qtdeclarative

      - name: Configure CMake
        run: cmake -S ui -B ui/build-tests -G Ninja -DBUILD_TESTING=ON -DCMAKE_PREFIX_PATH=$Qt6_DIR

      - name: Build UI tests
        run: cmake --build ui/build-tests

      - name: Run UI test suite
        run: ctest --test-dir ui/build-tests --output-on-failure

      - name: Generate coverage sample manifest
        run: python scripts/build_sample_manifest.py --output-dir tests/assets/coverage_sample

      - name: Coverage alert runner (nominal)
        run: >-
          python -m scripts.coverage_alert_runner
          --config tests/assets/coverage_sample/core.yaml
          --all-configured
          --as-of 2024-01-22T00:00:00+00:00
          --json

      - name: Coverage alert runner (threshold violation smoke)
        run: |
          set +e
          python -m scripts.coverage_alert_runner \
            --config tests/assets/coverage_sample/core.yaml \
            --all-configured \
            --as-of 2024-02-05T00:00:00+00:00 \
            --json > violation.json
          exit_code=$?
          set -e
          cat violation.json
          if [ "$exit_code" -eq 1 ]; then
            echo "Threshold violation triggered as expected"
          else
            echo "Expected exit code 1 but got $exit_code"
            exit 1
          fi

      - name: Upload coverage runner outputs
        uses: actions/upload-artifact@v4
        with:
          name: coverage-runner-smoke
          path: violation.json

  ui-tests:
    name: UI QML Tests
    runs-on: ubuntu-latest
    needs: prepare-pyside6-wheel
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: software
      PYTEST_REQUIRE_QML: "1"
      QML_DIAGNOSTICS_DIR: test-results/qml

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libgl1 libpulse0 libxkbcommon-x11-0 \
            libxcb-cursor0 libxcb-xinerama0

      - name: Download PySide6 wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: pyside6-wheels-linux-${{ env.PYSIDE6_VERSION }}
          path: wheelhouse

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-index --find-links wheelhouse \
            PySide6==${{ env.PYSIDE6_VERSION }} \
            PySide6_Addons==${{ env.PYSIDE6_VERSION }} \
            PySide6_Essentials==${{ env.PYSIDE6_VERSION }} \
            shiboken6==${{ env.PYSIDE6_VERSION }}
          pip install .[dev]

      - name: Run QML pytest suite
        run: |
          mkdir -p test-results/qml
          pytest -m qml --maxfail=1 --disable-warnings \
            --junitxml=test-results/qml/pytest.xml --durations=15

      - name: Upload QML diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qml-test-diagnostics
          path: test-results/qml
          if-no-files-found: warn

  grpc-feed-integration:
    name: gRPC Decision Feed Integration
    runs-on: ubuntu-latest
    needs: prepare-pyside6-wheel
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: software

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libgl1 libpulse0 libxkbcommon-x11-0 \
            libxcb-cursor0 libxcb-xinerama0

      - name: Download PySide6 wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: pyside6-wheels-linux-${{ env.PYSIDE6_VERSION }}
          path: wheelhouse

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-index --find-links wheelhouse \
            PySide6==${{ env.PYSIDE6_VERSION }} \
            PySide6_Addons==${{ env.PYSIDE6_VERSION }} \
            PySide6_Essentials==${{ env.PYSIDE6_VERSION }} \
            shiboken6==${{ env.PYSIDE6_VERSION }}
          pip install .[dev]

      - name: Generate trading stubs
        run: python scripts/generate_trading_stubs.py --skip-cpp

      - name: Run gRPC decision feed tests
        run: |
          mkdir -p test-results/grpc
          pytest tests/integration/test_grpc_transport.py -k "grpc" --maxfail=1 --disable-warnings \
            --junitxml=test-results/grpc/pytest.xml

      - name: Upload pytest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grpc-feed-pytest-results
          path: test-results/grpc
          if-no-files-found: warn

      - name: Upload decision feed metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: decision-feed-metrics
          path: reports/ci/decision_feed_metrics.json
          if-no-files-found: warn

  marketplace-catalog:
    name: Marketplace Catalog Packaging
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]

      - name: Build marketplace catalog
        run: |
          python scripts/build_marketplace_catalog.py \
            --private-key config/marketplace/keys/dev-presets-ed25519.key \
            --key-id dev-presets \
            --signing-key dev-hmac:config/marketplace/keys/dev-hmac.key

      - name: Validate catalog metadata
        run: python scripts/marketplace_cli.py validate --key dev-hmac:config/marketplace/keys/dev-hmac.key

      - name: Run marketplace catalog tests
        run: pytest tests/test_marketplace_catalog.py --maxfail=1 --disable-warnings

      - name: Ensure repository is clean
        run: |
          git status --porcelain
          git diff --stat
          git diff --quiet

      - name: Upload marketplace packages
        if: always()
        run: |
          tar -czf marketplace-packages.tar.gz -C config/marketplace packages

      - name: Publish marketplace packages artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-packages
          path: marketplace-packages.tar.gz
          if-no-files-found: error

  ui-packaging:
    name: UI Packaging
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 6.5.3
          modules: qtcharts qtquickcontrols2 qtdeclarative

      - name: Build Qt bundle
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python scripts/packaging/qt_bundle.py \
            --platform ${{ matrix.platform }} \
            --build-dir ui/build-${{ matrix.platform }} \
            --install-dir ui/install-${{ matrix.platform }} \
            --artifact-dir artifacts/ui/${{ matrix.platform }}

      - name: Upload UI bundle
        uses: actions/upload-artifact@v4
        with:
          name: ui-${{ matrix.platform }}
          path: artifacts/ui/${{ matrix.platform }}
