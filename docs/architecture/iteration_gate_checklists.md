# Checklisty bramek iteracyjnych Etapów 4–5

Dokument zbiera rozszerzone checklisty wejścia i wyjścia dla iteracji rozwojowych Etapu 4. Wszystkie punkty odnoszą się do pipeline'u demo → paper → live i muszą być odhaczone przed przejściem do kolejnej fazy. Kryteria integrują smoke testy środowiska paper, audyty decyzji oraz zgodność z profilami ryzyka.

## 1. Checklista wejścia iteracji

| Krok | Opis | Dowód/Artefakt |
| --- | --- | --- |
| 1 | Aktualizacja mapy profili ryzyka oraz koszyków instrumentów w `config/core.yaml`; uruchom `python scripts/validate_config.py --config config/core.yaml` | Raport walidacji zapisany w `audit/config_validation/iteracja_<nr>.json` |
| 2 | Synchronizacja presetów strategii w repo (`MeanReversionSettings`, `VolatilityTargetSettings`, `CrossExchangeArbitrageSettings`) z dokumentacją techniczną | PR z linkiem do `docs/architecture/strategies/*.md` |
| 3 | Weryfikacja smoke testu paper: `PYTHONPATH=. python scripts/run_paper_smoke_ci.py --environment binance_paper --render-summary-markdown` | `audit/paper_smoke/summary.json` + podpis HMAC w `docs/audit/paper_trading_log.jsonl` |
| 4 | Audyt tokenów RBAC i certyfikatów mTLS (`python scripts/audit_service_tokens.py --config config/core.yaml`, `python scripts/audit_tls_assets.py --config config/core.yaml`) | Raporty JSON w `audit/rbac/` i `audit/tls/` z aktualnymi SHA-256 |
| 5 | Aktualizacja checklist operacyjnych i planu testów regresyjnych (`docs/architecture/stage4_test_plan.md`, `docs/runbooks/paper_trading.md`) | Commit z referencją do numeru iteracji w `docs/architecture/stage4_progress.md` |

## 2. Checklista wyjścia iteracji

| Krok | Opis | Dowód/Artefakt |
| --- | --- | --- |
| 1 | Wyniki regresji jednostkowych i integracyjnych (`pytest tests/test_mean_reversion_strategy.py tests/test_multi_strategy_scheduler.py ...`) | Log z CI lub `logs/tests/iteracja_<nr>.txt` |
| 2 | Udane smoke testy paper (`summary.json`, `paper_smoke_report.zip`) zsynchronizowane przez `publish_paper_smoke_artifacts.py` oraz podpisane HMAC (`verify_decision_log.py`) | Raport `publish_summary.json` + wpis w `audit/paper_trading_log.md` |
| 3 | Decision log JSONL zawiera podpisane decyzje dla wszystkich strategii aktywnych w schedulerze (`python scripts/verify_decision_log.py --log audit/decisions --hmac-key $DECISION_KEY`) | `audit/decisions/verification_report.json` |
| 4 | Risk engine raportuje alokacje zgodne z profilami (`python bot_core/runtime/telemetry_risk_profiles.py --summary core`) | Plik `audit/risk_profiles/core_iteracja_<nr>.json` |
| 5 | Review operacyjny i bezpieczeństwa potwierdzony w `docs/audit/paper_trading_log.md` wraz z podpisem operatora | Nowy wpis z datą i identyfikatorem operatora |
| 6 | Zatwierdzona aktualizacja `docs/architecture/stage4_progress.md` oraz `iteration_gate_checklists.md` z procentami postępu | Merge request + notatka w decision logu |

> **Uwaga:** Każdy punkt checklisty wymaga dokumentacji w decision logu podpisanym kluczem HMAC oraz oznaczenia statusu w `stage4_progress.md`. W przypadku regresu (np. nieudany smoke test) pozycje należy przywrócić do `[ ]`, a metryki postępu zaktualizować przed kolejnym podejściem. Na potrzeby Etapu 5 należy dodatkowo odnotować spełnienie wymagań TCO/DecisionOrchestrator zgodnie ze specyfikacją `docs/architecture/stage5_spec.md`.

## 3. Checklista AI Decision Pipeline

| Krok | Opis | Dowód/Artefakt | Kamień sprintu (Phase 2 – Stream AI) |
| --- | --- | --- | --- |
| 1 | Artefakt modelu (`ModelArtifact`) zapisany w repozytorium modeli z metadanymi `target_scale`, `feature_scalers`, `training_rows`/`validation_rows` i metrykami MAE/RMSE (train + validation). | Plik JSON w katalogu wersji + pakiet `generate_model_artifact_bundle` (`*.metadata.json`, `checksums.sha256`, `*.sig`) oraz podpis w decision logu. | Sprint 1: `ModelArtifact` z kompletem metadanych + podpis w decision journalu. |
| 2 | Walidacja walk-forward (`WalkForwardValidator`) zakończona sukcesem, średnie MAE/directional accuracy zapisane w raporcie. | Raport z `tests/decision/test_scheduler.py` + log walidacji w `audit/ai_decision/`. | Sprint 2: Raporty walidacji walk-forward i monitoring danych wejściowych. |
| 3 | Scheduler retreningu (`RetrainingScheduler`) posiada aktualny `last_run` i zaplanowany `next_run`. | Zrzut konfiguracji/metryk w `audit/ai_decision/scheduler.json`. | Sprint 3: `RetrainingScheduler` z `last_run`/`next_run` w audycie. |
| 4 | `DecisionOrchestrator` zintegrowany z inference (`DecisionModelInference.is_ready == True`), `AIDecisionLoop` generuje kandydatów on-line. | Log z uruchomienia pętli oraz wpis audytowy w decision journal. | Sprint 3: Potwierdzony `is_ready` DecisionOrchestratora przed autotraderem. |
| 5 | Procedury compliance z `docs/architecture/ai_decision_pipeline.md` odhaczone (artefakty, monitoring danych OHLCV, alerty inference). | Checklist podpisana przez Risk/Compliance. | Sprint 4: Podpisane checklisty Risk/Compliance + raport dryfu przed go-live. |
| 6 | Review dystrybucji rozszerzonych cech trendowych i ryzyka (`ema_*_gap`, `dema_gap`, `tema_gap`, `hma_*`, `zlema_gap`, `vwma_gap`, `t3_*`, `supertrend_*`, `supertrend_direction_change`, `supertrend_bandwidth_change`, `supertrend_gap_change`, `frama_*`, `rsi`, `rsi_change`, `stochastic_*`, `stochastic_k_change`, `stochastic_rsi`, `williams_r`, `cci`, `price_zscore`, `price_zscore_change`, `price_median_gap`, `price_mad_ratio`, `price_percentile_low_gap`, `price_percentile_high_gap`, `price_percentile_spread`, `price_percent_rank`, `return_median_gap_bps`, `return_mad_ratio`, `return_percent_rank`, `volume_percent_rank`, `volume_median_gap`, `volume_mad_ratio`, `volume_return_median_gap`, `volume_return_mad_ratio`, `volume_return_percent_rank`, `volume_percentile_low_gap`, `volume_percentile_high_gap`, `volume_percentile_spread`, `range_percent_rank`, `range_mean_ratio`, `atr_percent_rank`, `return_skewness`, `return_kurtosis`, `volume_zscore`, `volume_zscore_change`, `volume_trend_slope`, `volume_trend_acceleration`, `volume_trend_strength`, `volatility_trend`, `atr_ratio`, `atr_ratio_change`, `atr_trend_slope`, `atr_trend_strength`, `atr_volatility_ratio`, `parkinson_volatility`, `garman_klass_volatility`, `rogers_satchell_volatility`, `yang_zhang_volatility`, `max_drawdown_ratio`, `max_drawdown_duration`, `drawdown_recovery_ratio`, `return_volatility_short`, `return_volatility_long`, `return_volatility_ratio`, `return_volatility_diff`, `volume_mean_short_ratio`, `volume_volatility_*`, `volume_spike_ratio`, `return_volume_correlation`, `price_volume_correlation`, wskaźniki Bollingera (w tym `bollinger_position_change`, `bollinger_width_change`), `macd_*` (wraz z `macd_histogram_change`), `ppo_*` (z uwzględnieniem `ppo_line_change`, `ppo_signal_change`, `ppo_signal_gap_change`, `ppo_histogram_change`), `fisher_transform`/`fisher_transform_change`, `fisher_signal_gap`/`fisher_signal_gap_change`, `fisher_signal_change`, `schaff_trend_cycle`/`schaff_trend_cycle_change`, `trix`, `trix_change`, `ultimate_oscillator`, `ultimate_oscillator_change`, `ease_of_movement`, `ease_of_movement_change`, `vortex_*`, `vortex_*_change`, `price_rate_of_change`, `price_rate_of_change_change`, `price_trend_slope`, `price_trend_acceleration`, `price_trend_strength`, `chande_momentum_oscillator`, `chande_momentum_change`, `detrended_price_oscillator`, `detrended_price_oscillator_change`, `aroon_*`, `balance_of_power`, `stochastic_rsi`, `stochastic_rsi_change`, `relative_vigor_*`, `relative_vigor_*_change`, `true_strength_*`, `true_strength_*_change`, `connors_rsi`, `connors_rsi_change`, `elder_ray_*`, `ulcer_index`, `efficiency_ratio`, `kama_*`, `qstick`, `qstick_change`, `obv_normalized`, `pvt_normalized`, pozytywny/negatywny indeks wolumenowy, `di_*`, `adx`, `adx_change`, `mfi`, `mfi_change`, `force_index_normalized`, cechy Ichimoku (w tym `ichimoku_price_position_change`), `donchian_*` (łącznie z `donchian_position_change`, `donchian_width_change`), `chaikin_money_flow`, `chaikin_money_flow_change`, linia akumulacji/dystrybucji, `chaikin_oscillator`, `chaikin_oscillator_change`, metryki Heikin Ashi (plus `heikin_trend_change`, `heikin_shadow_ratio_change`), kanały Keltnera (wraz z `keltner_position_change`, `keltner_width_change`), `vwap_gap`, `vwap_gap_change`, `psar_*`, `psar_direction_change`, pivoty P/R1/S1, luki fraktalne, `coppock_curve`, `choppiness_index`, `intraday_intensity`, `intraday_intensity_change`, `intraday_intensity_volume`, `intraday_intensity_volume_change`, `market_facilitation_index`, `market_facilitation_index_change`, `mass_index`, `mass_index_change`, wskaźnik Klingera (`klinger_*`, `klinger_oscillator_change`, `klinger_signal_change`), luki Alligatora (`alligator_*`, `alligator_*_change`), oscylator Gatora (`gator_oscillator_*`, `gator_oscillator_*_change`), cechy sezonowe (`session_time_*`, `day_of_week_*`, `week_of_year_*`, `month_*`, `day_of_month_progress`, `is_month_*`, `is_quarter_end`, `is_weekend`), nowe statystyki (`return_sharpe_like`, `return_sortino_like`, `downside_volatility`, `upside_volatility`, `return_autocorr`, `volume_autocorr`, `return_entropy`, `hurst_exponent`, `fractal_dimension`) oraz sygnały struktury świec i presji (`open_gap`, `close_location_value`, `candle_*_ratio`, `range_atr_ratio`, `body_atr_ratio`, `upper_shadow_atr_ratio`, `lower_shadow_atr_ratio`, `price_*_streak_ratio`, `volume_*_streak_ratio`, `volume_flow_imbalance`, `volume_flow_ratio`, `volume_flow_imbalance_change`) na zbiorach treningowych i walidacyjnych. | Raport z analizy statystyk `feature_stats` dołączony do decision journal. |
- **Nowy obowiązek:** w ramach przeglądu należy potwierdzić stabilność delt wygładzeń adaptacyjnych (`dema_gap_change`, `tema_gap_change`, `kama_*_change`, `frama_*_change`, `hma_*_change`, `zlema_gap_change`, `vwma_gap_change`, `t3_*_change`) i zarchiwizować log `audit/ai_decision/features_<data>_deltas.json`.

- **Nowy obowiązek:** w ramach powyższego przeglądu należy jawnie odnotować stabilność delt wygładzeń adaptacyjnych (`dema_gap_change`, `tema_gap_change`, `kama_*_change`, `frama_*_change`, `hma_*_change`, `zlema_gap_change`, `vwma_gap_change`, `t3_*_change`) oraz potwierdzić ich zakresy w logu monitoringu (`audit/ai_decision/features_<data>_deltas.json`).
- **Nowy obowiązek:** monitorować współczynniki recency ekstremów (`time_since_high_close_ratio`, `time_since_low_close_ratio`, `time_since_high_volume_ratio`, `time_since_low_volume_ratio`, `time_since_high_return_ratio`, `time_since_low_return_ratio`) i archiwizować raport porównawczy w `audit/ai_decision/features_<data>_recency.json`.
- **Nowy obowiązek:** audytować percentylowe diagnostyki dystrybucji zwrotów i zmian wolumenu (`return_percentile_low_gap_bps`, `return_percentile_high_gap_bps`, `return_percentile_spread_bps`, `volume_return_percentile_low_gap`, `volume_return_percentile_high_gap`, `volume_return_percentile_spread`) względem baseline'u testów regresyjnych.
- **Nowy obowiązek:** monitorować udziały znaków zwrotów i zmian wolumenu (`return_positive_share`, `return_negative_share`, `return_flat_share`, `return_sign_balance`, `volume_return_positive_share`, `volume_return_negative_share`, `volume_return_flat_share`, `volume_return_sign_balance`) i porównywać je z baseline'em testów regresyjnych.
- **Nowy obowiązek:** raportować udział amplitudy dodatnich/ujemnych zmian (`return_positive_magnitude_share`, `return_negative_magnitude_share`, `return_flat_magnitude_share`, `return_magnitude_balance`, `volume_return_positive_magnitude_share`, `volume_return_negative_magnitude_share`, `volume_return_flat_magnitude_share`, `volume_return_magnitude_balance`) wraz z porównaniem do baseline'u regresji.
- **Nowy obowiązek:** kontrolować korelacje krzyżowe zwrotów i zmian wolumenu (`return_volume_crosscorr_lag1`, `return_volume_crosscorr_lag3`, `return_volume_crosscorr_lag5`) pod kątem dryfu przepływu kapitału.
- **Nowy obowiązek:** monitorować korelacje zwrotów z rozpiętością świecy i relatywnym ATR (`return_range_correlation`, `return_range_crosscorr_lag1`, `return_range_crosscorr_lag3`, `return_range_crosscorr_lag5`, `return_atr_correlation`, `return_atr_crosscorr_lag1`, `return_atr_crosscorr_lag3`, `return_atr_crosscorr_lag5`).
| 7 | Audyt delt adaptacyjnych wygładzeń (`dema_gap_change`, `tema_gap_change`, `kama_*_change`, `frama_*_change`, `hma_*_change`, `zlema_gap_change`, `vwma_gap_change`, `t3_*_change`) pod kątem stabilności i dryfu cech. | Zestawienie porównawcze z `tests/decision/test_ai_pipeline.py::test_training_and_inference` oraz log z monitoringu `audit/ai_decision/features_<data>_deltas.json`. |
| 8 | Audyt współczynników recency ekstremów (`time_since_high_close_ratio`, `time_since_low_close_ratio`, `time_since_high_volume_ratio`, `time_since_low_volume_ratio`, `time_since_high_return_ratio`, `time_since_low_return_ratio`) względem baseline z testów regresyjnych. | Raport `audit/ai_decision/features_<data>_recency.json` + diff do `tests/decision/test_ai_pipeline.py::test_training_and_inference`. |
| 9 | Audyt percentylowych diagnostyk zwrotów i zmian wolumenu (`return_percentile_low_gap_bps`, `return_percentile_high_gap_bps`, `return_percentile_spread_bps`, `volume_return_percentile_low_gap`, `volume_return_percentile_high_gap`, `volume_return_percentile_spread`) względem baseline z testów regresyjnych. | Raport `audit/ai_decision/features_<data>_return_percentiles.json` + diff do `tests/decision/test_ai_pipeline.py::test_training_and_inference`. |
| 10 | Audyt udziałów znaków zwrotów i zmian wolumenu (`return_positive_share`, `return_negative_share`, `return_flat_share`, `return_sign_balance`, `volume_return_positive_share`, `volume_return_negative_share`, `volume_return_flat_share`, `volume_return_sign_balance`) względem baseline z testów regresyjnych. | Raport `audit/ai_decision/features_<data>_sign_distribution.json` + diff do `tests/decision/test_ai_pipeline.py::test_training_and_inference`. |
| 11 | Audyt udziałów amplitudy dodatnich/ujemnych zmian (`return_positive_magnitude_share`, `return_negative_magnitude_share`, `return_flat_magnitude_share`, `return_magnitude_balance`, `volume_return_positive_magnitude_share`, `volume_return_negative_magnitude_share`, `volume_return_flat_magnitude_share`, `volume_return_magnitude_balance`) względem baseline regresji. | Raport `audit/ai_decision/features_<data>_sign_magnitude.json` + diff do `tests/decision/test_ai_pipeline.py::test_training_and_inference`. |
| 12 | Audyt korelacji krzyżowych zwrotów i zmian wolumenu (`return_volume_crosscorr_lag1`, `return_volume_crosscorr_lag3`, `return_volume_crosscorr_lag5`). | Raport z monitoringu driftu przepływu kapitału (`audit/ai_decision/features_<data>_crosscorr.json`) + adnotacja compliance. |
| 13 | Audyt korelacji zwrotów z rozpiętością świecy i relatywnym ATR (`return_range_correlation`, `return_range_crosscorr_lag1`, `return_range_crosscorr_lag3`, `return_range_crosscorr_lag5`, `return_atr_correlation`, `return_atr_crosscorr_lag1`, `return_atr_crosscorr_lag3`, `return_atr_crosscorr_lag5`). | Raport z monitoringu sprzężenia momentum-zmienność (`audit/ai_decision/features_<data>_range_atr_corr.json`) + podpis compliance. |
| 6 | Review dystrybucji rozszerzonych cech trendowych i ryzyka (`ema_*_gap`, `dema_gap`, `tema_gap`, `frama_*`, `rsi`, `stochastic_*`, `stochastic_rsi`, `williams_r`, `cci`, `volume_zscore`, `volatility_trend`, `atr_ratio`, wskaźniki Bollingera, `macd_*`, `ppo_*`, `fisher_transform`, `fisher_signal_gap`, `schaff_trend_cycle`, `trix`, `ultimate_oscillator`, `ease_of_movement`, `vortex_*`, `price_rate_of_change`, `chande_momentum_oscillator`, `detrended_price_oscillator`, `aroon_*`, `balance_of_power`, `relative_vigor_*`, `true_strength_*`, `connors_rsi`, `elder_ray_*`, `ulcer_index`, `efficiency_ratio`, `kama_*`, `qstick`, `obv_normalized`, `pvt_normalized`, pozytywny/negatywny indeks wolumenowy, `di_*`, `adx`, `mfi`, `force_index_normalized`, cechy Ichimoku, `donchian_*`, `chaikin_money_flow`, linia akumulacji/dystrybucji, `chaikin_oscillator`, metryki Heikin Ashi, kanały Keltnera, `vwap_gap`, `psar_*`, pivoty P/R1/S1, luki fraktalne, `coppock_curve`, `choppiness_index`, `intraday_intensity`, `intraday_intensity_volume`, `mass_index`, wskaźnik Klingera (`klinger_*`)) na zbiorach treningowych i walidacyjnych. | Raport z analizy statystyk `feature_stats` dołączony do decision journal. |

### Sprintowe kamienie AI Decision Pipeline

| Sprint | Kamień | Powiązane punkty checklisty | Dowód/Artefakt |
| --- | --- | --- | --- |
| 1 | Repozytorium modeli z kompletnymi `ModelArtifact` | 1 | Pliki wersji modeli + podpis w decision journalu. |
| 2 | Raport walidacji walk-forward oraz monitoring danych wejściowych | 2 | Raporty MAE/directional accuracy w `audit/ai_decision/` + alerty dryfu danych. |
| 3 | Scheduler retreningu zaktualizowany i gotowość inference w DecisionOrchestrator | 3, 4 | Eksport `audit/ai_decision/scheduler.json` + log `is_ready == True`. |
| 4 | Checklisty compliance podpisane przez Risk/Compliance przed produkcją | 5 | Checklisty z podpisami oraz wpis w decision journalu blokujący go-live bez akceptacji. |
