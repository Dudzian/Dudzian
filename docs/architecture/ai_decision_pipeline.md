# AI Decision Pipeline

## Przepływ danych i scoringu

1. **Źródła OHLCV** – moduł `bot_core.data.ohlcv` dostarcza zunifikowane świece, które są normalizowane przez `CachedOHLCVSource` i udostępniane pipeline'owi AI.
2. **Feature engineering** – `FeatureEngineer` oblicza cechy momentum, zmienności, relacje wolumenu oraz rozpiętości cen dla okien kroczących. Zestaw rozszerzają wskaźniki trendowe (luka do EMA szybkiej/wolnej, DEMA/TEMA, HMA/ZLEMA, Tillson T3, MACD z histogramem i luką do sygnału, Average Directional Index z DI+/DI−, chmura Ichimoku z pozycją ceny, kanały Donchiana i Keltnera, luka względem Parabolic SAR, TRIX, Vortex, wskaźniki Aroon oraz adaptacyjny Supertrend i Alligator z oscylatorem Gatora), oscylatory (RSI, Bollinger position/width, Stochastic %K/%D, Stochastic RSI, Williams %R, Money Flow Index, Ultimate Oscillator, Chande Momentum Oscillator, Detrended Price Oscillator, Relative Vigor Index z linią sygnałową, True Strength Index, Schaff Trend Cycle, Fisher Transform, Percentage Price Oscillator) oraz miary momentum (`price_rate_of_change`, Elder Ray bull/bear power). Pipeline obejmuje też sygnały przepływu kapitału i struktury rynku (standaryzowany wolumen, trend zmienności, ATR ratio i percentyle (`range_percent_rank`, `atr_percent_rank`), CCI, znormalizowany OBV/PVT, pozytywny/negatywny indeks wolumenowy, Force Index, Chaikin Money Flow, Ease of Movement, linia akumulacji/dystrybucji z oscylatorem Chaikina, luka do VWAP, Balance of Power, Connors RSI, Intraday Intensity z komponentem wolumenowym, Market Facilitation Index oraz kanały/pivoty/fraktale i wskaźniki Heikin Ashi). Kontekst ryzyka uzupełniają Ulcer Index, efficiency ratio, adaptacyjne KAMA i FRAMA (luka + nachylenie), krzywa Coppocka, indeks choppiness, mass index, wskaźnik Klingera oraz Qstick, a także diagnostyki reżimów (`return_sharpe_like`, `return_sortino_like`, kierunkowe zmienności, autokorelacje zwrotów i wolumenów, entropia kierunku, wykładnik Hursta, wymiar fraktalny). Najnowsza iteracja dodaje monitorowanie delt luk i nachyleń dla adaptacyjnych średnich (DEMA/TEMA, KAMA/FRAMA, HMA/ZLEMA, Tillson T3, VWMA), aby inference otrzymywało nie tylko poziomy, ale też dynamikę wygładzeń. Dodatkowo śledzimy recency poziomów – współczynniki czasu od ostatniego maksimum/minimum ceny, wolumenu oraz zwrotu w oknie, aby modele mogły reagować na świeżość ekstremów rynkowych, oraz percentylowe diagnostyki zwrotów i zmian wolumenu, które sygnalizują przesunięcia dystrybucji względem kwartylowych benchmarków. Rozszerzyliśmy też diagnostykę kierunku o udziały dodatnich/ujemnych/neutralnych zwrotów oraz bilans znaków dla cen i wolumenów, aby szybciej wykrywać dryf reżimu w danych treningowych. Najnowsza aktualizacja dodaje również wskaźniki udziału amplitudy (suma dodatnich vs. ujemnych zmian) dla zwrotów i zmian wolumenu, aby modele mogły rozróżniać dominację jednej strony rynku nawet przy zbilansowanej liczbie sygnałów. Kolejny krok rozszerza ten pakiet o korelacje krzyżowe zwrotów i zmian wolumenu w kilku opóźnieniach, co pozwala uchwycić efekt przepływu kapitału przesuniętego w czasie. Najświeższe rozszerzenie obejmuje również korelacje i cross-korelacje zwrotów z relatywnym zakresem świecy oraz wskaźnikiem ATR, dzięki czemu pipeline monitoruje sprzężenie momentum z rozpiętością i zmiennością rynku.

   Najnowsze iteracje wzbogaciły zestaw o statystyki dystrybucji (z-score ceny, percentyle ceny i wolumenu, skośność i kurtozę zwrotów), sezonowe cechy kalendarzowe (sinus/cosinus czasu doby i dnia tygodnia, postęp tygodnia i miesiąca, flagi weekendów oraz początków/końców miesięcy i kwartałów) oraz korelacje między rynkowymi sygnałami. Bieżąca rozbudowa dodaje relacje short/long dla zmienności i wolumenu (`return_volatility_short`/`long`/`ratio`, `volume_mean_short_ratio`, `volume_volatility_*`) oraz miary `return_volume_correlation` i `price_volume_correlation`, które pomagają identyfikować przejścia płynnościowe. Najświeższy inkrement koncentruje się na strukturze świec (`open_gap`, `close_location_value`, `candle_*_ratio`) i sekwencyjnych sygnałach kontynuacji/presji (`price_*_streak_ratio`, `volume_*_streak_ratio`, `volume_flow_imbalance`, `volume_flow_ratio`), domykając obraz przepływu kapitału. Aktualna iteracja dodaje miary trwałości i akceleracji trendów (`range_mean_ratio`, `return_volatility_diff`, `volume_spike_ratio`, `price_trend_acceleration`, `volume_trend_acceleration`) oraz diagnostykę drawdownów i dryfu zmienności (`max_drawdown_ratio`, `max_drawdown_duration`, `drawdown_recovery_ratio`, `atr_trend_slope`, `atr_trend_strength`, `atr_volatility_ratio`) wraz z estymatorami zmienności opartymi na świecach (`parkinson_volatility`, `garman_klass_volatility`, `rogers_satchell_volatility`, `yang_zhang_volatility`) i miarami normalizującymi strukturę świec względem ATR (`range_atr_ratio`, `body_atr_ratio`, `upper_shadow_atr_ratio`, `lower_shadow_atr_ratio`), które wzmacniają kontrolę breakoutów, zbieżności momentum ceny z wolumenem oraz monitorują kondycję ryzyka. Najnowsza poprawka dokłada medianowe normalizacje (`price_median_gap`, `price_mad_ratio`, `volume_median_gap`, `volume_mad_ratio`) oraz luki percentylowe i rozpiętości (`price_percentile_low_gap`, `price_percentile_high_gap`, `price_percentile_spread`, `volume_percentile_low_gap`, `volume_percentile_high_gap`, `volume_percentile_spread`), ułatwiające audyt odchyleń od rozkładów centralnych i wykrywanie anomalii wolumenu, a także kontrolę dystrybucji bieżących zwrotów i przyrostów wolumenowych (`return_median_gap_bps`, `return_mad_ratio`, `return_percent_rank`, `volume_return_median_gap`, `volume_return_mad_ratio`, `volume_return_percent_rank`). Kolejne rozszerzenie dokłada delty kluczowych wskaźników (`rsi_change`, `stochastic_k_change`, `adx_change`, `atr_ratio_change`, `price_zscore_change`, `volume_zscore_change`, `macd_histogram_change`) oraz warstwę monitoringu przepływu z `mfi_change`, `chaikin_oscillator_change`, `ichimoku_price_position_change`, `supertrend_gap_change`, `volume_flow_imbalance_change`, `klinger_oscillator_change` i `klinger_signal_change`, aby monitorować dynamikę krótkoterminową, wolumenowe dysproporcje i reakcje trendowe. Najnowsza iteracja rozwija to o delty kanałów i oscylatorów (`bollinger_position_change`, `bollinger_width_change`, `donchian_position_change`, `donchian_width_change`, `keltner_position_change`, `keltner_width_change`), sygnały wolumenowo‑trendowe (`chaikin_money_flow_change`, `intraday_intensity_change`, `intraday_intensity_volume_change`, `market_facilitation_index_change`, `mass_index_change`) oraz delty struktur świec i momentum (`heikin_trend_change`, `heikin_shadow_ratio_change`, `vwap_gap_change`, `psar_direction_change`) i adaptacyjnych wskaźników trendu (`supertrend_direction_change`, `supertrend_bandwidth_change`, `alligator_*_change`, `gator_oscillator_*_change`), a bieżąca poprawka rozszerza monitorowanie o delty oscylatorów momentum (`trix_change`, `ultimate_oscillator_change`, `ease_of_movement_change`, `vortex_*_change`, `price_rate_of_change_change`, `chande_momentum_change`, `detrended_price_oscillator_change`, `stochastic_rsi_change`, `relative_vigor_*_change`, `true_strength_*_change`, `connors_rsi_change`, `qstick_change`), zamykając pętlę obserwacji na zmianach przepływu i trendu. Najnowszy przyrost dodaje także delty sygnałów PPO (`ppo_line_change`, `ppo_signal_change`, `ppo_signal_gap_change`, `ppo_histogram_change`), Fisher Transform (`fisher_transform_change`, `fisher_signal_change`, `fisher_signal_gap_change`) oraz Schaff Trend Cycle (`schaff_trend_cycle_change`), aby wychwytywać adaptacyjne przejścia reżimów momentum. Targetem pozostaje przyszły zwrot w punktach bazowych, monitorowany przez wskaźniki momentum, a każdy `FeatureDataset` zapisuje metadane `feature_names` i `feature_stats`, ułatwiając audyt stabilności dystrybucji cech.
3. **Trenowanie** – `ModelTrainer` standaryzuje cechy na podstawie statystyk z porcji treningowej i wykorzystuje `SimpleGradientBoostingModel` do budowy artefaktu (`ModelArtifact`). Opcjonalny `validation_split` odkłada część próbek na walidację, generując metryki MAE/RMSE (train + validation), liczbę wierszy treningowych/walidacyjnych oraz mapę `feature_scalers` (średnia, odchylenie) umożliwiającą odtworzenie normalizacji podczas inference.
4. **Repozytorium modeli** – `ModelRepository` utrzymuje wersjonowane artefakty (JSON). Retrain scheduler odkłada nowe artefakty w wybranym katalogu, a inference ładuje je on-line.
5. **Inference** – `DecisionModelInference` mapuje cechy kandydata na oczekiwany zwrot i prawdopodobieństwo sukcesu. Przed scoringiem uzupełnia brakujące cechy średnimi z `feature_scalers` i standaryzuje wartości identycznie jak w treningu. Wynik wstrzykiwany jest do `DecisionOrchestrator`, który łączy scoring z limitami kosztów i ryzyka.
6. **Decision loop** – `AIDecisionLoop` w `bot_core.runtime.controller` buduje dataset w locie, tworzy kandydatów z metadanymi cech i odpytuje orchestrator wraz z snapshotem ryzyka.

## Walidacja walk-forward

- `WalkForwardValidator` dzieli zbiór cech na okna treningowe/testowe, dla każdego trenuje model i liczy średnie MAE oraz directional accuracy.
- Wyniki walidacji należy archiwizować razem z metadanymi treningu i wskaźnikiem `target_scale` – pozwala to audytować kalibrację prawdopodobieństwa inference.
- Testy jednostkowe w `tests/decision/` pokrywają retraining scheduler oraz pipeline walidacji.

## Checklisty compliance

- **AI Artefacts** – każda wersja modelu musi mieć: (a) podpisany artefakt (`ModelArtifact`), (b) raport metryk z walidacji walk-forward, (c) wpis w decision journal z informacją o aktywacji modelu, (d) zweryfikowaną zgodność `feature_scalers` z danymi treningowymi.
- **On-line scoring** – przed wdrożeniem zweryfikuj, że `DecisionOrchestrator` ładuje aktualne wagi (`DecisionModelInference.is_ready == True`) oraz że `AIDecisionLoop` loguje odchylenia kosztów w alertach.
- **Retraining** – scheduler powinien mieć dowód ostatniego wykonania (`RetrainingScheduler.last_run`) i plan kolejnego (`next_run`). Brak retreningu > interwał wymaga otwarcia incydentu risk/compliance.
- **Dane wejściowe** – `FeatureEngineer` wymaga kompletności kolumn OHLCV. Monitoring musi raportować luki oraz nieciągłości w `bot_core.data.ohlcv` przed uruchomieniem inference.
